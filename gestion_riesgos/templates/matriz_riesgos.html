{% extends 'base.html' %}
{% block title %}Matriz de Riesgos IPER{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Matriz de Riesgos IPER</h1>
    <a href="{% url 'riesgo_create' %}" class="btn btn-success">Añadir Nuevo Riesgo</a>
</div>

<div class="table-responsive">
    <table class="table table-bordered table-hover table-riesgos align-middle">
        <thead class="table-dark">
            <tr>
                <th rowspan="2">Proceso / Tarea</th>
                <th rowspan="2">Riesgo Específico</th>
                <th colspan="3" class="text-center">Riesgo Inherente</th>
                <th rowspan="2">Medidas de Control</th>
                <th colspan="3" class="text-center">Riesgo Residual</th>
                <th rowspan="2">Acciones</th>
            </tr>
            <tr>
                <th class="text-center">P</th>
                <th class="text-center">C</th>
                <th class="text-center">VEP</th>
                <th class="text-center">P</th>
                <th class="text-center">C</th>
                <th class="text-center">VEP</th>
            </tr>
        </thead>
        <tbody>
            {% for riesgo in riesgos %}
            <tr>
                <td>
                    <strong>{{ riesgo.tarea.proceso.nombre }}</strong><br>
                    <small>{{ riesgo.tarea.descripcion }}</small>
                </td>
                <td>
                    <a href="{% url 'riesgo_detail' riesgo.pk %}">{{ riesgo.riesgo_especifico }}</a>
                </td>
                <td class="text-center">{{ riesgo.probabilidad }}</td>
                <td class="text-center">{{ riesgo.consecuencia_valor }}</td>
                <td class="text-center clasificacion-{{ riesgo.clasificacion_riesgo }}">
                    <b>{{ riesgo.valor_vep }}</b>
                </td>

                <td>
                    <small>
                        {% for medida in riesgo.medidas_control.all %}
                            - {{ medida.descripcion|truncatewords:5 }} <br>
                        {% empty %}
                            Sin medidas
                        {% endfor %}
                    </small>
                </td>

                <td class="text-center">{{ riesgo.probabilidad_residual|default:"-" }}</td>
                <td class="text-center">{{ riesgo.consecuencia_residual|default:"-" }}</td>
                <td class="text-center clasificacion-{{ riesgo.clasificacion_riesgo_residual }}">
                    <b>{{ riesgo.valor_vep_residual|default:"-" }}</b>
                </td>

                <td>
                    <a href="{% url 'riesgo_detail' riesgo.pk %}" class="btn btn-sm btn-info">Ver/Gestionar</a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="10" class="text-center">No hay riesgos en la matriz. <a href="{% url 'riesgo_create' %}">Añade el primero</a>.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}