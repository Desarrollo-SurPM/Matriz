{% extends 'base.html' %}

{% block title %}Matriz IPER | Risk-Bee{% endblock %}

{% block extra_css %}
<style>
    /* === 1. ESTILOS GENERALES Y ENCABEZADO === */
    
    .header-paper {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }

    .form-label-sm {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        font-weight: 700;
        margin-bottom: 4px;
    }

    .form-control-paper {
        border: 1px solid #dee2e6;
        background-color: #f8f9fa;
        border-radius: 4px;
        font-size: 0.9rem;
        padding: 8px 12px;
        transition: all 0.2s;
    }
    .form-control-paper:focus {
        background-color: #fff;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(107, 142, 115, 0.1);
    }

    .signature-box {
        border: 1px dashed #ced4da;
        background-color: #fcfcfc;
        padding: 15px;
        border-radius: 6px;
        height: 100%;
        text-align: center;
    }
    .signature-title {
        font-size: 0.7rem;
        font-weight: 800;
        text-transform: uppercase;
        color: var(--accent-secondary);
        margin-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 5px;
        display: block;
    }

    /* === 2. ESTILOS DE LA MATRIZ (TABLA) === */
    
    .matriz-wrapper {
        overflow: auto; /* Scroll en ambas direcciones */
        height: 70vh;   /* Altura fija de la ventana de la tabla */
        border: 1px solid #ced4da;
        background: #fff;
        border-radius: 6px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        position: relative;
    }

    .table-iper {
        border-collapse: separate; 
        border-spacing: 0;
        font-family: 'Inter', system-ui, sans-serif;
        font-size: 13px; /* Letra más legible */
        min-width: max-content; /* Fuerza el ancho total */
    }

    /* Cabeceras Sticky (Fijas) */
    .table-iper thead {
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .table-iper th {
        border-right: 1px solid rgba(0,0,0,0.1);
        border-bottom: 1px solid rgba(0,0,0,0.2);
        padding: 12px 8px;
        text-align: center;
        vertical-align: middle;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.3px;
        color: #212529;
    }

    /* Colores de Secciones (Pasteles más profesionales) */
    .th-blue   { background-color: #e3f2fd; } /* Procesos */
    .th-orange { background-color: #fff3e0; } /* Peligros */
    .th-green  { background-color: #e8f5e9; } /* Evaluación */
    .th-yellow { background-color: #fffde7; } /* Gestión */
    .th-purple { background-color: #f3e5f5; } /* Residual */
    .th-gray   { background-color: #f8f9fa; } /* General */

    /* Celdas del Cuerpo */
    .table-iper td {
        border-right: 1px solid #eee;
        border-bottom: 1px solid #eee;
        padding: 0;
        vertical-align: top;
        background: #fff;
        min-height: 50px; /* Altura mínima para que no se vea aplastado */
    }

    /* Inputs Invisibles pero Espaciosos */
    .cell-input {
        width: 100%;
        height: 100%;
        min-height: 50px; /* Altura cómoda */
        border: none;
        padding: 10px; /* Espacio interior para que el texto no toque bordes */
        font-family: inherit;
        font-size: inherit;
        background: transparent;
        outline: none;
        resize: vertical; /* Permite estirar si es necesario */
        display: block;
        line-height: 1.4;
        color: #333;
    }
    
    .cell-input:focus {
        background-color: #fff;
        box-shadow: inset 0 0 0 2px var(--accent-primary);
        z-index: 10;
        position: relative;
    }

    /* Selectores dentro de celdas */
    select.cell-input {
        cursor: pointer;
        padding-right: 20px;
        background-color: transparent;
    }

    /* Celdas Calculadas (Read Only) */
    .cell-calc {
        background-color: #f8f9fa;
        font-weight: 700;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        min-height: 50px;
        font-size: 12px;
        color: #495057;
    }

    /* Semáforo de Riesgos (Colores Vivos) */
    .riesgo-trivial    { background-color: #a5d6a7 !important; color: #1b5e20; }
    .riesgo-tolerable  { background-color: #66bb6a !important; color: #fff; }
    .riesgo-moderado   { background-color: #fff176 !important; color: #333; }
    .riesgo-importante { background-color: #ffa726 !important; color: #fff; }
    .riesgo-intolerable{ background-color: #ef5350 !important; color: #fff; }

    /* Columnas Ocultas (Inclusión) */
    .col-inclusion { display: none; background-color: #fce4ec; }
    .col-inclusion.show { display: table-cell; }

    /* Toast Flotante */
    #save-status {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: #2d3436;
        color: #fff;
        padding: 10px 20px;
        border-radius: 50px;
        font-size: 13px;
        font-weight: 500;
        display: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        z-index: 2000;
        align-items: center;
        gap: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">

    <div class="header-paper fade-in-up">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 pb-3 border-bottom">
                <div class="d-flex align-items-center gap-3 mb-3 mb-md-0">
                    {% if matriz.empresa.logo %}
                        <img src="{{ matriz.empresa.logo.url }}" alt="Logo" style="height: 50px; width: auto;">
                    {% else %}
                        <div class="bg-light rounded p-2 text-muted fw-bold border"><i class="fas fa-image"></i> LOGO</div>
                    {% endif %}
                    <div>
                        <h4 class="mb-0 fw-bold text-dark">MATRIZ IPER</h4>
                        <small class="text-muted">Identificación de Peligros y Evaluación de Riesgos (Guía ISP 3 / DS 44)</small>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'empresa_detail' matriz.empresa.pk %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                    <button type="submit" name="save_header" class="btn btn-primary-modern btn-sm px-4">
                        <i class="fas fa-save me-2"></i>Guardar Encabezado
                    </button>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label class="form-label-sm">Empresa</label>
                    <input type="text" class="form-control form-control-paper" value="{{ matriz.empresa.razon_social }}" readonly>
                </div>
                <div class="col-md-4">
                    <label class="form-label-sm">Departamento / Área</label>
                    {{ form.departamento_sucursal }} </div>
                <div class="col-md-4">
                    <label class="form-label-sm">Proyecto / Contrato</label>
                    {{ form.proyecto }}
                </div>
                
                <div class="col-md-3">
                    <label class="form-label-sm">Fecha Documento</label>
                    {{ form.fecha_documento }}
                </div>
                <div class="col-md-3">
                    <label class="form-label-sm">Versión</label>
                    {{ form.version }}
                </div>
                <div class="col-md-3">
                    <label class="form-label-sm">Código Interno</label>
                    {{ form.codigo_documento }}
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-4">
                    <div class="signature-box">
                        <span class="signature-title">Elaborado Por</span>
                        <div class="mb-2">
                            <input type="text" name="elaborado_por" value="{{ form.elaborado_por.value|default:'' }}" class="form-control form-control-sm mb-1 text-center" placeholder="Nombre Completo">
                            <input type="text" name="cargo_elabora" value="{{ form.cargo_elabora.value|default:'' }}" class="form-control form-control-sm text-center text-muted" placeholder="Cargo">
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="signature-box">
                        <span class="signature-title">Revisado Por</span>
                        <div class="mb-2">
                            <input type="text" name="revisado_por" value="{{ form.revisado_por.value|default:'' }}" class="form-control form-control-sm mb-1 text-center" placeholder="Nombre Completo">
                            <input type="text" name="cargo_revisa" value="{{ form.cargo_revisa.value|default:'' }}" class="form-control form-control-sm text-center text-muted" placeholder="Cargo">
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="signature-box">
                        <span class="signature-title">Aprobado Por</span>
                        <div class="mb-2">
                            <input type="text" name="aprobado_por" value="{{ form.aprobado_por.value|default:'' }}" class="form-control form-control-sm mb-1 text-center" placeholder="Nombre Completo">
                            <input type="text" name="cargo_aprueba" value="{{ form.cargo_aprueba.value|default:'' }}" class="form-control form-control-sm text-center text-muted" placeholder="Cargo">
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-2 px-1">
        <div>
            <button class="btn btn-sm btn-outline-secondary rounded-pill px-3" onclick="toggleInclusion()" id="btn-inclusion">
                <i class="fas fa-wheelchair me-2"></i>Mostrar/Ocultar Inclusión (Ley 21.015)
            </button>
        </div>
        <div class="text-muted small">
            <i class="fas fa-info-circle me-1"></i> Los cambios en la tabla se guardan automáticamente.
        </div>
    </div>

    <div class="matriz-wrapper">
        <table class="table-iper">
            <thead>
                <tr>
                    <th rowspan="2" class="th-gray" style="width: 40px;">#</th>
                    <th colspan="5" class="th-blue">1. IDENTIFICACIÓN DE PROCESOS</th>
                    <th colspan="5" class="th-orange">2. IDENTIFICACIÓN PELIGROS</th>
                    <th class="th-orange">3. CONTROL</th>
                    <th colspan="4" class="th-green">4. EVALUACIÓN (PURA)</th>
                    <th colspan="3" class="th-yellow">5. GESTIÓN</th>
                    <th colspan="4" class="th-purple">6. EVALUACIÓN (RESIDUAL)</th>
                    <th rowspan="2" class="th-gray col-inclusion" style="width: 250px;">CONDICIÓN ESPECIAL<br>(INCLUSIÓN)</th>
                    <th rowspan="2" class="th-gray" style="width: 200px;">OBSERVACIONES</th>
                    <th rowspan="2" class="th-gray" style="width: 40px;"></th>
                </tr>
                
                <tr>
                    <th class="th-blue" style="min-width: 180px;">Proceso</th>
                    <th class="th-blue" style="min-width: 100px;">Género</th>
                    <th class="th-blue" style="min-width: 180px;">Puesto Trabajo</th>
                    <th class="th-blue" style="min-width: 220px;">Tarea</th>
                    <th class="th-blue" style="min-width: 110px;">Rutina</th>
                    
                    <th class="th-orange" style="min-width: 70px;">Cod.</th>
                    <th class="th-orange" style="min-width: 220px;">Peligro / Factor</th>
                    <th class="th-orange" style="min-width: 220px;">Riesgo</th>
                    <th class="th-orange" style="min-width: 220px;">Consecuencia</th>
                    <th class="th-orange" style="min-width: 100px;">GEMA</th>
                    
                    <th class="th-orange" style="min-width: 280px;">Medida Control Actual</th>
                    
                    <th class="th-green" style="min-width: 60px;">P</th>
                    <th class="th-green" style="min-width: 60px;">S</th>
                    <th class="th-green" style="min-width: 60px;">VR</th>
                    <th class="th-green" style="min-width: 110px;">Clasificación</th>
                    
                    <th class="th-yellow" style="min-width: 220px;">Requisito Legal</th>
                    <th class="th-yellow" style="min-width: 150px;">Resp. Ejecución</th>
                    <th class="th-yellow" style="min-width: 150px;">Resp. Seguimiento</th>
                    
                    <th class="th-purple" style="min-width: 60px;">P(R)</th>
                    <th class="th-purple" style="min-width: 60px;">S(R)</th>
                    <th class="th-purple" style="min-width: 60px;">VR(R)</th>
                    <th class="th-purple" style="min-width: 110px;">Clasif.(R)</th>
                </tr>
            </thead>
            
            <tbody id="matriz-body">
                {% for fila in filas %}
                <tr data-id="{{ fila.id }}">
                    <td class="text-center bg-light text-muted fw-bold">{{ forloop.counter }}</td>
                    
                    <td><textarea class="cell-input" onchange="save(this, 'proceso')">{{ fila.proceso|default:'' }}</textarea></td>
                    <td>
                        <select class="cell-input" onchange="save(this, 'genero')">
                            <option value="">...</option>
                            <option value="Hombre" {% if fila.genero == 'Hombre' %}selected{% endif %}>Hombre</option>
                            <option value="Mujer" {% if fila.genero == 'Mujer' %}selected{% endif %}>Mujer</option>
                            <option value="Ambos" {% if fila.genero == 'Ambos' %}selected{% endif %}>Ambos</option>
                            <option value="Otro" {% if fila.genero == 'Otro' %}selected{% endif %}>Otro</option>
                        </select>
                    </td>
                    <td><textarea class="cell-input" onchange="save(this, 'puesto_trabajo')">{{ fila.puesto_trabajo|default:'' }}</textarea></td>
                    <td><textarea class="cell-input" onchange="save(this, 'tarea')">{{ fila.tarea|default:'' }}</textarea></td>
                    <td>
                        <select class="cell-input" onchange="save(this, 'tipo_rutina')">
                            <option value="">...</option>
                            <option value="Rutinaria" {% if fila.tipo_rutina == 'Rutinaria' %}selected{% endif %}>Rutinaria</option>
                            <option value="No Rutinaria" {% if fila.tipo_rutina == 'No Rutinaria' %}selected{% endif %}>No Rutinaria</option>
                            <option value="Emergencia" {% if fila.tipo_rutina == 'Emergencia' %}selected{% endif %}>Emergencia</option>
                        </select>
                    </td>
                    
                    <td><input type="text" class="cell-input text-center" onchange="save(this, 'codigo_riesgo')" value="{{ fila.codigo_riesgo|default:'' }}"></td>
                    <td><textarea class="cell-input" onchange="save(this, 'peligro_factor')">{{ fila.peligro_factor|default:'' }}</textarea></td>
                    <td><textarea class="cell-input" onchange="save(this, 'riesgo')">{{ fila.riesgo|default:'' }}</textarea></td>
                    <td><textarea class="cell-input" onchange="save(this, 'consecuencia')">{{ fila.consecuencia|default:'' }}</textarea></td>
                    <td>
                        <select class="cell-input text-center" onchange="save(this, 'gema')">
                            <option value="">...</option>
                            <option value="Gente" {% if fila.gema == 'Gente' %}selected{% endif %}>G</option>
                            <option value="Equipo" {% if fila.gema == 'Equipo' %}selected{% endif %}>E</option>
                            <option value="Material" {% if fila.gema == 'Material' %}selected{% endif %}>M</option>
                            <option value="Ambiente" {% if fila.gema == 'Ambiente' %}selected{% endif %}>A</option>
                        </select>
                    </td>
                    
                    <td><textarea class="cell-input" onchange="save(this, 'medida_control_actual')">{{ fila.medida_control_actual|default:'' }}</textarea></td>
                    
                    <td>
                        <select class="cell-input text-center fw-bold" id="p-{{ fila.id }}" onchange="calcRisk('{{ fila.id }}', 'pura'); save(this, 'eval_probabilidad')">
                            <option value="1" {% if fila.eval_probabilidad == 1 %}selected{% endif %}>1</option>
                            <option value="2" {% if fila.eval_probabilidad == 2 %}selected{% endif %}>2</option>
                            <option value="4" {% if fila.eval_probabilidad == 4 %}selected{% endif %}>4</option>
                        </select>
                    </td>
                    <td>
                        <select class="cell-input text-center fw-bold" id="s-{{ fila.id }}" onchange="calcRisk('{{ fila.id }}', 'pura'); save(this, 'eval_severidad')">
                            <option value="1" {% if fila.eval_severidad == 1 %}selected{% endif %}>1</option>
                            <option value="2" {% if fila.eval_severidad == 2 %}selected{% endif %}>2</option>
                            <option value="4" {% if fila.eval_severidad == 4 %}selected{% endif %}>4</option>
                            <option value="8" {% if fila.eval_severidad == 8 %}selected{% endif %}>8</option>
                        </select>
                    </td>
                    <td class="cell-calc"><span id="vr-{{ fila.id }}">{{ fila.eval_valor }}</span></td>
                    <td class="cell-calc"><span id="class-{{ fila.id }}" class="badge rounded-pill fw-normal text-dark">{{ fila.eval_clasificacion }}</span></td>
                    
                    <td><textarea class="cell-input" onchange="save(this, 'requisito_legal')" placeholder="Ej: DS 594...">{{ fila.requisito_legal|default:'' }}</textarea></td>
                    <td><textarea class="cell-input" onchange="save(this, 'responsable_ejecucion')">{{ fila.responsable_ejecucion|default:'' }}</textarea></td>
                    <td><textarea class="cell-input" onchange="save(this, 'responsable_seguimiento')">{{ fila.responsable_seguimiento|default:'' }}</textarea></td>
                    
                    <td>
                        <select class="cell-input text-center fw-bold" id="pr-{{ fila.id }}" onchange="calcRisk('{{ fila.id }}', 'residual'); save(this, 'residual_probabilidad')">
                            <option value="1" {% if fila.residual_probabilidad == 1 %}selected{% endif %}>1</option>
                            <option value="2" {% if fila.residual_probabilidad == 2 %}selected{% endif %}>2</option>
                            <option value="4" {% if fila.residual_probabilidad == 4 %}selected{% endif %}>4</option>
                        </select>
                    </td>
                    <td>
                        <select class="cell-input text-center fw-bold" id="sr-{{ fila.id }}" onchange="calcRisk('{{ fila.id }}', 'residual'); save(this, 'residual_severidad')">
                            <option value="1" {% if fila.residual_severidad == 1 %}selected{% endif %}>1</option>
                            <option value="2" {% if fila.residual_severidad == 2 %}selected{% endif %}>2</option>
                            <option value="4" {% if fila.residual_severidad == 4 %}selected{% endif %}>4</option>
                            <option value="8" {% if fila.residual_severidad == 8 %}selected{% endif %}>8</option>
                        </select>
                    </td>
                    <td class="cell-calc"><span id="vrr-{{ fila.id }}">{{ fila.residual_valor }}</span></td>
                    <td class="cell-calc"><span id="classr-{{ fila.id }}" class="badge rounded-pill fw-normal text-dark">{{ fila.residual_clasificacion }}</span></td>
                    
                    <td class="col-inclusion">
                        <textarea class="cell-input" onchange="save(this, 'condicion_especial')" placeholder="Describir ajustes...">{{ fila.condicion_especial|default:'' }}</textarea>
                    </td>
                    
                    <td><textarea class="cell-input" onchange="save(this, 'reevaluacion')">{{ fila.reevaluacion|default:'' }}</textarea></td>
                    
                    <td class="text-center align-middle">
                        <button class="btn btn-sm text-danger" title="Eliminar Fila" onclick="alert('Función de eliminar pendiente de implementar en backend')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
                
                <tr class="bg-light border-top">
                    <td class="text-center fw-bold text-success align-middle" style="font-size: 1.2rem;">+</td>
                    <td colspan="23">
                        <input type="text" class="cell-input fst-italic text-muted px-3" 
                               placeholder="Haz clic aquí para agregar una nueva fila..." 
                               onfocus="createRow()" 
                               style="height: 40px; cursor: pointer;">
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div id="save-status">
    <i class="fas fa-spinner fa-spin"></i>
    <span>Guardando...</span>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // --- 1. MOSTRAR / OCULTAR COLUMNA INCLUSIÓN ---
    function toggleInclusion() {
        const cols = document.querySelectorAll('.col-inclusion');
        const btn = document.getElementById('btn-inclusion');
        
        cols.forEach(col => col.classList.toggle('show'));
        
        if (cols[0].classList.contains('show')) {
            btn.classList.add('active', 'bg-secondary', 'text-white');
        } else {
            btn.classList.remove('active', 'bg-secondary', 'text-white');
        }
    }

    // --- 2. CÁLCULO DE RIESGO DINÁMICO (Lógica IPER) ---
    function calcRisk(rowId, type) {
        // IDs dinámicos
        const pId = type === 'pura' ? `p-${rowId}` : `pr-${rowId}`;
        const sId = type === 'pura' ? `s-${rowId}` : `sr-${rowId}`;
        const vrId = type === 'pura' ? `vr-${rowId}` : `vrr-${rowId}`;
        const classId = type === 'pura' ? `class-${rowId}` : `classr-${rowId}`;

        // Obtener valores
        const p = parseInt(document.getElementById(pId).value) || 1;
        const s = parseInt(document.getElementById(sId).value) || 1;
        const vr = p * s;

        // Elementos de destino
        const vrSpan = document.getElementById(vrId);
        const classSpan = document.getElementById(classId);
        const vrCell = vrSpan.closest('td'); // La celda contenedora (td)
        const classCell = classSpan.closest('td');

        // Actualizar Valor Numérico
        vrSpan.innerText = vr;

        // Lógica de Clasificación (Según tu Excel Valoración)
        let clasificacion = "TRIVIAL";
        let claseColor = "riesgo-trivial";

        if (vr >= 16) {
            clasificacion = "INTOLERABLE";
            claseColor = "riesgo-intolerable";
        } else if (vr >= 8) {
            clasificacion = "IMPORTANTE";
            claseColor = "riesgo-importante";
        } else if (vr >= 4) {
            clasificacion = "MODERADO";
            claseColor = "riesgo-moderado";
        } else if (vr >= 2) {
            clasificacion = "TOLERABLE";
            claseColor = "riesgo-tolerable";
        }

        // Actualizar Texto y Colores
        classSpan.innerText = clasificacion;
        
        // Limpiar clases previas en la celda y aplicar la nueva
        vrCell.className = `cell-calc ${claseColor}`;
        classCell.className = `cell-calc ${claseColor}`;
        
        // El badge interno puede quedar transparente o heredar
        classSpan.className = "badge rounded-pill fw-normal text-white"; // Texto blanco por defecto
        if (claseColor === "riesgo-moderado") classSpan.classList.add("text-dark"); // Excepción oscuro

        // Guardado Silencioso a BD
        if (type === 'pura') {
            save({ value: vr }, 'eval_valor', rowId, true);
            save({ value: clasificacion }, 'eval_clasificacion', rowId, true);
        } else {
            save({ value: vr }, 'residual_valor', rowId, true);
            save({ value: clasificacion }, 'residual_clasificacion', rowId, true);
        }
    }

    // --- 3. GUARDADO AUTOMÁTICO (AJAX) ---
    const matrizId = "{{ matriz.id }}";
    const statusBox = document.getElementById('save-status');

    function save(input, field, explicitId = null, silent = false) {
        const rowId = explicitId ? explicitId : input.closest('tr').dataset.id;
        const value = input.value !== undefined ? input.value : input.innerText;

        if(!silent) {
            statusBox.style.display = 'flex';
            statusBox.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            statusBox.style.background = '#2d3436';
        }

        fetch("{% url 'update_detalle_iper' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                id: rowId,
                matriz_id: matrizId,
                field: field,
                value: value
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'ok' || data.status === 'created') {
                if(!silent) {
                    statusBox.innerHTML = '<i class="fas fa-check"></i> Guardado';
                    statusBox.style.background = '#00b894';
                    setTimeout(() => statusBox.style.display = 'none', 1000);
                }
            } else {
                statusBox.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                statusBox.style.background = '#d63031';
            }
        })
        .catch(err => {
            console.error(err);
            statusBox.innerHTML = 'Error Red';
        });
    }

    // --- 4. CREAR NUEVA FILA ---
    function createRow() {
        save({ value: 'Nuevo Proceso' }, 'proceso', 'new');
        // Pequeño delay para que la BD cree el registro antes de recargar
        setTimeout(() => location.reload(), 300);
    }

    // --- 5. UTILIDADES ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- 6. INICIALIZACIÓN ---
    document.addEventListener("DOMContentLoaded", function() {
        // Calcular colores iniciales para todas las filas
        {% for fila in filas %}
            calcRisk('{{ fila.id }}', 'pura');
            calcRisk('{{ fila.id }}', 'residual');
        {% endfor %}
    });
</script>
{% endblock %}