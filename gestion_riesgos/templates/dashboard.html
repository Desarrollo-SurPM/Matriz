{% extends 'base.html' %}
{% block title %}Dashboard Principal{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="text-gradient" style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">Dashboard Principal</h1>
        <p style="color: var(--text-secondary); margin: 0;">Bienvenido a tu panel de control</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'recordatorio_create' %}" class="btn-outline-modern">
            <i class="bi bi-bell me-1"></i> Recordatorio
        </a>
        <a href="{% url 'visita_create' %}" class="btn-primary-modern">
            <i class="bi bi-plus-circle me-1"></i> Agendar Visita
        </a>
    </div>
</div>

<style>
.nav-tabs {
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 2rem;
}
.nav-tabs .nav-link {
    color: var(--text-secondary);
    border: none;
    border-bottom: 3px solid transparent;
    padding: 1rem 1.5rem;
    font-weight: 600;
    transition: all var(--transition-base);
}
.nav-tabs .nav-link:hover {
    color: var(--text-primary);
    border-bottom-color: var(--accent-primary);
    background: rgba(99, 102, 241, 0.1);
}
.nav-tabs .nav-link.active {
    color: var(--accent-primary);
    background: transparent;
    border-bottom-color: var(--accent-primary);
}
.list-group-item {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    transition: all var(--transition-base);
}
.list-group-item:hover {
    background: var(--bg-hover);
    border-color: var(--border-light);
    transform: translateX(4px);
}
.list-group-item h6 {
    color: var(--text-primary);
}
.badge-legend {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 4px;
    margin-right: 8px;
}
</style>

<ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="planificacion-tab" data-bs-toggle="tab" data-bs-target="#planificacion" type="button" role="tab" aria-controls="planificacion" aria-selected="true">
            <i class="bi bi-calendar-week me-2"></i> Planificación
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="riesgos-tab" data-bs-toggle="tab" data-bs-target="#riesgos" type="button" role="tab" aria-controls="riesgos" aria-selected="false">
            <i class="bi bi-graph-up me-2"></i> Inteligencia de Riesgos
        </button>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{% url 'reporte_accidente_list' %}">
            <i class="bi bi-clipboard-pulse me-2"></i> Reporte de Accidentes
        </a>
    </li>
</ul>

<div class="tab-content" id="dashboardTabsContent">

    <div class="tab-pane fade show active" id="planificacion" role="tabpanel" aria-labelledby="planificacion-tab">
        <div class="card-modern">
            <div class="card-header-modern">
                <h3><i class="bi bi-calendar3 me-2"></i>Calendario de Eventos</h3>
            </div>
                <div id='calendar'></div>

                <div class="divider"></div>
                <h5 class="mt-4 mb-3" style="color: var(--text-primary);"><i class="bi bi-list-check me-2"></i>Próximos Eventos</h5>
                <div class="list-group">
                    {% for evento in proximos_eventos %}
                        {% if evento.asunto %} {# Es una Visita #}
                            <a href="{% url 'visita_update' evento.pk %}" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1"><i class="bi bi-building" style="color: var(--info);"></i> Visita: {{ evento.asunto }}</h6>
                                        <p class="mb-0 small" style="color: var(--text-secondary);">{{ evento.empresa.razon_social }}</p>
                                    </div>
                                    <span class="badge-modern">{{ evento.fecha_hora|date:"d M, H:i" }}</span>
                                </div>
                            </a>
                        {% else %} {# Es un Recordatorio #}
                            <a href="{% url 'recordatorio_update' evento.pk %}" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1"><i class="bi bi-bell" style="color: var(--success);"></i> Recordatorio: {{ evento.titulo }}</h6>
                                        <p class="mb-0 small" style="color: var(--text-secondary);">{{ evento.descripcion|truncatewords:15 }}</p>
                                    </div>
                                    <span class="badge-modern">{{ evento.fecha_hora|date:"d M, H:i" }}</span>
                                </div>
                            </a>
                        {% endif %}
                    {% empty %}
                        <div class="list-group-item text-center">
                            <i class="bi bi-calendar-x" style="font-size: 3rem; color: var(--text-muted); opacity: 0.3;"></i>
                            <p style="color: var(--text-muted); margin-top: 1rem;">No tienes eventos próximos agendados.</p>
                        </div>
                    {% endfor %}
                </div>

                <div class="mt-4 d-flex gap-3 flex-wrap" style="font-size: 0.9rem;">
                    <div><span class="badge-legend" style="background-color:#dc3545;"></span> Vencimiento Legal</div>
                    <div><span class="badge-legend" style="background-color:#0d6efd;"></span> Visita</div>
                    <div><span class="badge-legend" style="background-color:#198754;"></span> Recordatorio</div>
                </div>
        </div>
    </div>

    <div class="tab-pane fade" id="riesgos" role="tabpanel" aria-labelledby="riesgos-tab">
        <div class="card-modern">
            <div class="card-header-modern">
                <h3><i class="bi bi-pie-chart me-2"></i>Análisis de Riesgos</h3>
            </div>
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <h5 style="color: var(--text-primary); margin-bottom: 1.5rem; text-align: center;">
                            <i class="bi bi-pie-chart-fill me-2"></i>Distribución de Riesgos por Clasificación
                        </h5>
                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius-lg);">
                            <canvas id="clasificacionChart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <h5 style="color: var(--text-primary); margin-bottom: 1.5rem; text-align: center;">
                            <i class="bi bi-bar-chart-fill me-2"></i>Jerarquía de Medidas de Control
                        </h5>
                        <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius-lg);">
                            <canvas id="jerarquiaChart"></canvas>
                        </div>
                    </div>
                </div>
        </div>
    </div>
</div>

<div class="modal fade" id="eventDetailModal" tabindex="-1" aria-labelledby="eventDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-color);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                <h5 class="modal-title text-gradient" id="eventDetailModalLabel">Detalles del Evento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-primary);"><strong>Evento:</strong> <span id="eventTitle" style="color: var(--text-secondary);"></span></p>
                <p style="color: var(--text-primary);"><strong>Fecha:</strong> <span id="eventDate" style="color: var(--text-secondary);"></span></p>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                <button type="button" class="btn-ghost" data-bs-dismiss="modal">Cerrar</button>
                <a id="editEventButton" href="#" class="btn-primary-modern">Editar / Ver Detalles</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- LÓGICA DEL CALENDARIO ---
    var calendarEl = document.getElementById('calendar');
    var eventModal = new bootstrap.Modal(document.getElementById('eventDetailModal'));

    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        events: "{% url 'all_events' %}",
        locale: 'es',
        buttonText: { today: 'Hoy', month: 'Mes', week: 'Semana', list: 'Lista' },
        
        eventClick: function(info) {
            info.jsEvent.preventDefault(); 
            
            document.getElementById('eventTitle').textContent = info.event.title;
            
            let eventDate = info.event.start;
            let dateOptions = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
            let formattedDate = eventDate ? eventDate.toLocaleDateString('es-CL', dateOptions).replace(',', '') : 'Todo el día';
            document.getElementById('eventDate').textContent = formattedDate;

            document.getElementById('editEventButton').href = info.event.url;
            
            eventModal.show();
        }
    });
    calendar.render();

    // --- LÓGICA DE LOS GRÁFICOS DE RIESGOS ---
    const riskTab = document.getElementById('riesgos-tab');
    let chartsLoaded = false;
    
    riskTab.addEventListener('shown.bs.tab', function () {
        if (!chartsLoaded) {
            fetch("{% url 'dashboard_chart_data' %}")
                .then(response => response.json())
                .then(data => {
                    // Gráfico de Clasificación
                    const ctxClasificacion = document.getElementById('clasificacionChart').getContext('2d');
                    new Chart(ctxClasificacion, {
                        type: 'doughnut',
                        data: {
                            labels: data.clasificacion_labels,
                            datasets: [{
                                label: 'N° de Riesgos',
                                data: data.clasificacion_counts,
                                backgroundColor: ['rgba(217, 83, 79, 0.7)', 'rgba(240, 173, 78, 0.7)', 'rgba(255, 243, 205, 0.9)', 'rgba(212, 237, 218, 0.9)', 'rgba(200, 200, 200, 0.7)'],
                                borderColor: 'white',
                                borderWidth: 2
                            }]
                        },
                        options: { responsive: true, plugins: { legend: { position: 'top' } } }
                    });

                    // Gráfico de Jerarquía
                    const ctxJerarquia = document.getElementById('jerarquiaChart').getContext('2d');
                    new Chart(ctxJerarquia, {
                        type: 'bar',
                        data: {
                            labels: data.jerarquia_labels,
                            datasets: [{
                                label: 'Cantidad de Controles Implementados',
                                data: data.jerarquia_counts,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: { indexAxis: 'y', responsive: true, scales: { x: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                    });

                    chartsLoaded = true;
                });
        }
    });
});
</script>
{% endblock %}